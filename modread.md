# 天使恶魔回复生成器浏览器插件 - 模块详细设计文档

## 输入处理模块

### 1. 需求文档的深入理解：

* 核心功能：接收用户输入（复制粘贴）的对方话语，并进行预处理。
* 需求点：
  - 提供文本输入框，允许用户粘贴或输入对方的话语
  - 对输入的文本进行基本的清理和格式化
  - 确保输入的文本不为空
  - 可能需要限制输入文本的长度，以适应API的要求

### 2. 详细设计：

* **UI设计：**
    * 界面布局：
      - 在插件弹出窗口顶部放置一个大型文本输入框
      - 在输入框下方放置一个"分析"按钮
    * 交互方式：
      - 用户可以直接在文本框中输入或粘贴文本
      - 点击"分析"按钮后进行下一步意图识别模块处理
    * 用户体验：
      - 提供清晰的输入提示，例如"请在此输入或粘贴对方的话"
      - 当文本框为空时，禁用"分析"按钮
      - 当输入超过字数限制时，给出友好提示

* **算法逻辑：**
    * 核心算法：
      1. 接收用户输入的文本
      2. 去除文本首尾的空白字符
      3. 将多个连续的空白字符替换为单个空格
      4. 检查文本是否为空
      5. 检查文本长度是否在允许范围内
      6. 记录上次分析的文本内容
      7. 在用户点击“分析”按钮时，检查当前输入文本是否与上次分析的文本相同
         - 如果相同，阻止分析操作并提示用户输入新的文本
         - 如果不同，继续进行分析操作
    * 数据结构：
      - 使用字符串存储和处理输入的文本
      - 新增：使用字符串变量存储上次分析的文本内容**
    * 异常处理：
      - 处理空输入：显示错误消息，提示用户输入文本
      - 处理过长输入：截断文本或显示错误消息，提示用户缩短输入
      - 新增：处理重复分析请求：显示提示消息，告知用户输入文本未发生变化

* **API接口：**
    * 接口名称：processInput
    * 请求参数：inputText (string) - 用户输入的原始文本
    * 返回值：
      - processedText (string) - 处理后的文本
      - isValid (boolean) - 输入是否有效
      - errorMessage (string) - 如果输入无效，返回错误消息
    * 错误码：
      - 001: 输入为空
      - 002: 输入超过最大长度限制

### 3. 测试用例设计：

* **正常情况：**
    1. 输入: "  Hello,   world!  " 
       预期输出: {processedText: "Hello, world!", isValid: true, errorMessage: ""}
    2. 输入: "This is a normal sentence."
       预期输出: {processedText: "This is a normal sentence.", isValid: true, errorMessage: ""}

* **异常情况：**
    1. 输入: "" (空字符串)
       预期输出: {processedText: "", isValid: false, errorMessage: "输入不能为空"}
    2. 输入: "   " (只有空白字符)
       预期输出: {processedText: "", isValid: false, errorMessage: "输入不能为空"}
    3. 用户重复点击“分析”按钮，输入文本未发生变化
       预期输出: {processedText: "", isValid: false, errorMessage: "输入文本未发生变化，请输入新的文本进行分析"}
       预期行为: 阻止分析操作，显示提示消息

* **边界情况：**
    1. 输入: 最大允许长度的文本
       预期输出: {processedText: [最大长度的文本], isValid: true, errorMessage: ""}
    2. 输入: 超过最大允许长度1个字符的文本
       预期输出: {processedText: "", isValid: false, errorMessage: "输入超过最大长度限制"}

## 意图识别模块

### 1. 需求文档的深入理解：

* 核心功能：接入大模型API，对输入的话语进行意图识别，生成天使版和恶魔版的意图解读。
* 需求点：
  - 调用大模型API进行意图分析
  - 生成两种不同版本（天使版和恶魔版）的意图解读
  - 确保API调用的稳定性和响应速度
  - 处理API可能返回的错误或异常情况

### 2. 详细设计：

* **UI设计：**
    * 界面布局：
      - 在输入框和"分析"按钮下方显示加载动画，表示正在进行意图识别
      - 分别展示天使版和恶魔版的意图解读结果
    * 交互方式：
      - 用户点击"分析"按钮后自动进行意图识别
      - 允许用户在结果显示后选择天使版或恶魔版
    * 用户体验：
      - 在API调用过程中显示友好的加载提示
      - 清晰地区分和展示天使版和恶魔版的解读结果

* **算法逻辑：**
    * 核心算法：
      1. 接收来自输入处理模块的文本
      2. 构造API请求，包含必要的参数和提示词
      3. 发送API请求到大模型服务
      4. 解析API返回的结果
      5. 提取并格式化天使版和恶魔版的意图解读
    * 数据结构：
      - 使用JSON对象存储API请求和响应数据
      - 使用字符串数组分别存储天使版和恶魔版的解读结果
    * 异常处理：
      - 处理API调用超时：重试或提示用户稍后再试
      - 处理API返回错误：显示友好的错误消息，并提供重试选项
      - 处理解析错误：如果返回数据格式异常，给出适当的错误提示

* **API接口：**
    * 接口名称：analyzeIntent
    * 请求参数：
      - inputText (string) - 用户输入的处理后文本
      - apiKey (string) - 大模型API的认证密钥
    * 返回值：
      - angelVersion (string) - 天使版意图解读
      - devilVersion (string) - 恶魔版意图解读
      - success (boolean) - API调用是否成功
      - errorMessage (string) - 如果调用失败，返回错误消息
    * 错误码：
      - 101: API调用失败
      - 102: 响应解析错误
      - 103: API密钥无效

### 3. 测试用例设计：

* **正常情况：**
    1. 输入: "你今天看起来很漂亮"
       预期输出: {
         angelVersion: "对方在赞美你的外表，表达了善意和欣赏。",
         devilVersion: "对方可能只是在说客套话，不一定是真心的。",
         success: true,
         errorMessage: ""
       }
    2. 输入: "我觉得这个项目做得不够好"
       预期输出: {
         angelVersion: "对方在提供建设性的反馈，希望项目能够改进。",
         devilVersion: "对方在贬低你的工作，可能对你有偏见。",
         success: true,
         errorMessage: ""
       }

* **异常情况：**
    1. API调用失败
       输入: "测试文本"
       预期输出: {
         angelVersion: "",
         devilVersion: "",
         success: false,
         errorMessage: "API调用失败，请稍后重试"
       }
    2. 无效的API密钥
       输入: "测试文本"
       预期输出: {
         angelVersion: "",
         devilVersion: "",
         success: false,
         errorMessage: "无效的API密钥，请检查您的设置"
       }

* **边界情况：**
    1. 输入非常长的文本（接近API允许的最大长度）
       预期输出: 正常返回解读结果，但可能需要较长处理时间
    2. 输入包含特殊字符或表情符号的文本
       预期输出: API应能正常处理，返回合理的解读结果

## 用户选择模块

### 1. 需求文档的深入理解：

* 核心功能：展示天使版和恶魔版的意图解读，允许用户选择天使或恶魔版本。
* 需求点：
  - 清晰展示两种版本的意图解读结果
  - 提供直观的选择界面
  - 记录用户的选择，以便后续生成相应的回复话术

### 2. 详细设计：

* **UI设计：**
    * 界面布局：
      - 在意图识别结果下方显示两个选项：天使版和恶魔版
      - 每个选项包含一个图标（如天使和恶魔的图标）和对应的意图解读文本
      - 添加一个"生成回复"按钮
    * 交互方式：
      - 用户可以点击选择天使版或恶魔版
      - 选中的版本会有明显的视觉反馈（如高亮显示）
      - 点击"生成回复"按钮后进入下一步
    * 用户体验：
      - 使用醒目的颜色和图标区分天使版和恶魔版
      - 提供简洁的说明文字，指导用户进行选择

* **算法逻辑：**
    * 核心算法：
      1. 接收来自意图识别模块的两种版本解读结果
      2. 展示两种版本的解读结果
      3. 捕获用户的选择
      4. 将用户选择的版本传递给下一个模块（回复生成模块）
    * 数据结构：
      - 使用布尔值存储用户的选择（true 表示天使版，false 表示恶魔版）
    * 异常处理：
      - 处理用户未选择情况：禁用"生成回复"按钮，直到用户做出选择

* **API接口：**
    * 接口名称：getUserChoice
    * 请求参数：无
    * 返回值：
      - choice (boolean) - 用户的选择（true 表示天使版，false 表示恶魔版）
      - selectedVersion (string) - 选中版本的意图解读文本

### 3. 测试用例设计：

* **正常情况：**
    1. 用户选择天使版
       预期输出: {choice: true, selectedVersion: "天使版的意图解读文本"}
    2. 用户选择恶魔版
       预期输出: {choice: false, selectedVersion: "恶魔版的意图解读文本"}

* **异常情况：**
    1. 用户未做选择就点击"生成回复"按钮
       预期行为: "生成回复"按钮应保持禁用状态，并提示用户需要先做出选择

* **边界情况：**
    1. 用户多次切换选择
       预期行为: 系统应正确记录最后一次的选择，并在点击"生成回复"时返回正确的结果
    2. 意图解读文本特别长
       预期行为: UI应适当调整以确保文本完整显示，可能需要使用滚动条或折叠/展开功能

## 回复生成模块

### 1. 需求文档的深入理解：

* 核心功能：根据用户选择的版本（天使/恶魔）生成相应的回复话术。
* 需求点：
  - 基于用户选择和原始输入生成合适的回复
  - 提供多个回复选项供用户选择
  - 确保生成的回复与选择的版本（天使/恶魔）风格一致
  - 生成的回复应该自然、得体，并与原始对话内容相关

### 2. 详细设计：

* **UI设计：**
    * 界面布局：
      - 显示原始输入文本和选择的版本（天使/恶魔）
      - 以列表形式展示生成的多个回复选项
      - 每个回复选项旁边提供一个"复制"按钮
    * 交互方式：
      - 用户可以滚动浏览所有生成的回复选项
      - 点击"复制"按钮可以复制相应的回复内容
    * 用户体验：
      - 使用不同的样式区分天使版和恶魔版的回复
      - 提供刷新按钮，允许用户重新生成回复

* **算法逻辑：**
    * 核心算法：
      1. 接收原始输入文本和用户选择的版本（天使/恶魔）
      2. 构造API请求，包含必要的参数和提示词，同时指定生成积极和消极两种回复
      3. 调用大模型API生成多个回复选项，包括积极和消极两种风格
      4. 解析API返回的结果，提取生成的回复
      5. 格式化回复内容，确保与选择的版本（天使/恶魔）和情感倾向（积极/消极）一致
    * 数据结构：
      - 使用嵌套的字符串数组存储生成的多个回复选项，区分积极和消极
    * 异常处理：
      - 处理API调用失败：提供重试选项或使用预设的通用回复
      - 处理生成内容不适当：提供过滤机制，确保回复内容的适当性

* **API接口：**
    * 接口名称：generateReplies
    * 请求参数：
      - inputText (string) - 原始输入文本
      - version (boolean) - 选择的版本（true 表示天使版，false 表示恶魔版）
      - apiKey (string) - 大模型API的认证密钥
    * 返回值：
      - replies (object) - 生成的回复选项对象，包含积极和消极两种类型
        - positive (array of strings) - 积极回复选项列表
        - negative (array of strings) - 消极回复选项列表
      - success (boolean) - API调用是否成功
      - errorMessage (string) - 如果调用失败，返回错误消息
    * 错误码：
      - 201: API调用失败
      - 202: 生成的回复不适当
      - 203: API密钥无效

### 3. 测试用例设计：

* **正常情况：**
    1. 天使版回复生成
       输入: {inputText: "你今天看起来很疲惫", version: true}
       预期输出: {
         replies: {
           positive: [
             "谢谢你的关心，我确实有点累，但我会好好休息的。你真贴心！",
             "你的关心让我感到温暖，我会注意劳逸结合的。谢谢你！"
           ],
           negative: [
             "是啊，最近工作压力很大，感觉快撑不住了。",
             "确实很累，感觉生活一团糟。"
           ]
         },
         success: true,
         errorMessage: ""
       }
    2. 恶魔版回复生成
       输入: {inputText: "你的表现让我很失望", version: false}
       预期输出: {
         replies: {
           positive: [
             "哦，真遗憾我没能满足你的期望。不过没关系，我会继续努力的！",
             "感谢你的反馈，这给了我改进的动力。我会做得更好的！"
           ],
           negative: [
             "失望是相互的，我对你的领导能力同样感到失望。",
             "也许你应该反思一下自己的标准是不是太高了？"
           ]
         },
         success: true,
         errorMessage: ""
       }

* **异常情况：**
    1. API调用失败
       预期输出: {
         replies: {},
         success: false,
         errorMessage: "API调用失败，请稍后重试"
       }
    2. 生成的回复不适当
       预期行为: 系统应该过滤掉不适当的内容，只返回适当的回复，或提示需要重新生成

* **边界情况：**
    1. 输入文本极短或极长
       预期行为: 系统应该能够处理各种长度的输入，并生成合适的回复
    2. 请求生成大量回复选项
       预期行为: 系统应该能够处理，但可能需要较长的响应时间，应该给用户合适的提示

## 复制功能模块

### 1. 需求文档的深入理解：

* 核心功能：允许用户方便地复制选中的回复话术。
* 需求点：
  - 为每个生成的回复选项提供复制功能
  - 实现一键复制，提高用户效率
  - 提供复制成功的反馈

### 2. 详细设计：

* **UI设计：**
    * 界面布局：
      - 在每个回复选项旁边添加一个"复制"按钮和一个"刷新"按钮
      - 复制按钮使用直观的图标（如剪贴板图标）
      - 刷新按钮使用循环箭头图标
    * 交互方式：
      - 用户点击"复制"按钮即可复制对应的回复内容
      - 用户点击"刷新"按钮可以重新生成该回复选项
      - 复制成功后提供视觉反馈（如按钮颜色变化或显示"已复制"提示）
      - 刷新操作开始时显示加载动画，完成后更新回复内容
    * 用户体验：
      - 复制和刷新操作应该快速响应
      - 提供清晰的视觉反馈，让用户知道操作是否成功

* **算法逻辑：**
    * 核心算法：
      1. 监听复制按钮和刷新按钮的点击事件
      2. 复制功能：
         - 获取对应回复选项的文本内容
         - 使用浏览器的 Clipboard API 将内容复制到剪贴板
         - 提供复制成功的反馈
      3. 刷新功能：
         - 调用回复生成模块的 API 重新生成单个回复
         - 更新界面上的回复内容
    * 数据结构：
      - 使用字符串存储要复制的文本内容
      - 使用对象存储回复选项的 ID 和内容，便于刷新操作
    * 异常处理：
      - 处理复制失败的情况：如果 Clipboard API 不可用或复制操作失败，提供错误提示
      - 处理刷新失败的情况：如果 API 调用失败，保留原有回复内容并提示用户重试

* **API接口：**
    * 接口名称：copyToClipboard
    * 请求参数：
      - text (string) - 要复制的文本内容
    * 返回值：
      - success (boolean) - 复制操作是否成功
      - errorMessage (string) - 如果复制失败，返回错误消息

    * 接口名称：refreshSingleReply
    * 请求参数：
      - replyId (string) - 需要刷新的回复选项 ID
      - version (boolean) - 选择的版本（true 表示天使版，false 表示恶魔版）
      - sentiment (string) - 情感倾向（"positive" 或 "negative"）
    * 返回值：
      - newReply (string) - 新生成的回复内容
      - success (boolean) - 刷新操作是否成功
      - errorMessage (string) - 如果刷新失败，返回错误消息

### 3. 测试用例设计：

* **正常情况：**
    1. 复制短文本
       输入: "这是一个测试回复。"
       预期输出: {success: true, errorMessage: ""}
       预期行为: 文本成功复制到剪贴板，UI提供复制成功的反馈
    2. 复制长文本
       输入: "这是一个较长的测试回复，包含多个句子。它可能会跨越多行。我们需要确保整个内容都能被正确复制。"
       预期输出: {success: true, errorMessage: ""}
       预期行为: 整段文本成功复制到剪贴板，UI提供复制成功的反馈
    3. 刷新单个回复
       输入: {replyId: "reply1", version: true, sentiment: "positive"}
       预期输出: {newReply: "这是一个新生成的积极回复。", success: true, errorMessage: ""}
       预期行为: 界面上对应的回复内容被更新，显示新生成的回复

* **异常情况：**
    1. Clipboard API 不可用
       预期输出: {success: false, errorMessage: "复制功能不可用，请手动复制文本。"}
       预期行为: 显示错误消息，可能提供文本选择功能让用户手动复制
    2. 复制操作被用户的浏览器或操作系统阻止
       预期输出: {success: false, errorMessage: "复制操作被阻止，请检查您的浏览器设置。"}
       预期行为: 显示错误消息，提供如何启用复制功能的指导
    3. 刷新操作失败
       输入: {replyId: "reply1", version: true, sentiment: "positive"}
       预期输出: {newReply: "", success: false, errorMessage: "刷新失败，请稍后重试"}
       预期行为: 显示错误消息，保留原有的回复内容

* **边界情况：**
    1. 复制空文本
       输入: ""
       预期输出: {success: true, errorMessage: ""}
       预期行为: 操作成功，但不会有实际内容被复制到剪贴板
    2. 复制包含特殊字符的文本
       输入: "这是一个特殊字符测试：!@#$%^&*()_+{}|:<>?[];\',./`~"
       预期输出: {success: true, errorMessage: ""}
       预期行为: 所有字符都应被正确复制到剪贴板
    3. 快速连续点击刷新按钮
       预期行为: 应该有防抖措施，避免重复调用 API，只响应最后一次点击

## 前端页面设计和交互模块

### 1. 需求文档的深入理解：

* 核心功能：设计并实现插件的整体用户界面，确保用户体验流畅、直观且美观。
* 需求点：
  - 创建符合浏览器插件风格的界面
  - 实现流畅的页面转换和交互
  - 确保界面美观且易于使用
  - 适配不同的屏幕尺寸和分辨率
  - 实现响应式设计，确保在不同设备上的良好体验
  - 遵循提供的UI参考图，实现直观的用户交互流程

### 2. 详细设计：

* **UI设计：**
    * 初始状态：
      - 显示一个简洁的图标，代表插件的功能
      - 图标设计应该能够直观地表达"天使恶魔回复生成器"的概念
    * 输入框界面：
      - 点击图标后展开一个输入框
      - 输入框上方显示简短的使用说明
      - 输入框下方放置"分析"按钮
      - 整体设计简洁、现代，使用柔和的色彩
    * 意图识别界面：
      - 显示两个并排的卡片，分别代表天使版和恶魔版的意图解读
      - 每个卡片包含相应的图标（天使/恶魔）和解读文本
      - 使用视觉差异（如颜色、图标）明确区分两个版本
    * 回复生成界面：
      - 顶部显示用户选择的版本（天使/恶魔）
      - 中间部分展示生成的回复选项，每个选项附带复制和刷新按钮
      - 底部提供返回按钮，允许用户重新选择版本
    * 配色方案：
      - 主色调：使用柔和的蓝色 (#3498db) 代表天使
      - 辅助色：使用温暖的红色 (#e74c3c) 代表恶魔
      - 背景色：使用浅灰色 (#f5f5f5) 确保内容清晰可读
      - 文字颜色：主要使用深灰色 (#333333)，强调文字使用黑色 (#000000)

* **交互设计：**
    *整体布局：
     - 使用简洁的卡片式设计
     - 顶部显示插件logo和名称
     - 主体区域根据不同功能模块动态变化
     - 底部显示版本信息和必要的链接（如帮助、设置等）
    * 页面流转：
      1. 初始状态：显示插件图标
      2. 点击图标：展开输入框界面
      3. 输入文本并点击"分析"：进入意图识别界面
      4. 选择天使或恶魔版本：进入回复生成界面
      5. 在回复生成界面可以复制或刷新单个回复，也可以返回重新选择版本
    * 动画效果：
      - 图标点击后平滑展开输入框
      - 页面间转换使用滑动效果
      - 为按钮添加轻微的悬停效果，增强交互感
      - 在复制操作后显示简短的成功动画
      - 刷新单个回复时显示加载动画
    * 响应式设计：
      - 确保界面在不同尺寸的浏览器窗口中都能正常显示
      - 可能需要为较小的屏幕优化布局，如将并排的卡片改为上下排列
    * 字体选择：
     - 使用无衬线字体，如 Roboto 或 Arial，确保在各种设备上的清晰度
     - 标题使用稍大和加粗的字体，正文使用常规字重
    * 图标设计：
     - 使用简洁的线条图标，确保在小尺寸下也清晰可辨
     - 为天使和恶魔版本设计独特的图标，增强视觉识别度


* **开发技术：**
    * 前端框架：使用 Vue.js 或 React 构建用户界面
    * CSS 框架：使用 Tailwind CSS 实现响应式设计
    * 图标库：使用 Font Awesome 或自定义 SVG 图标
    * 构建工具：使用 Webpack 或 Vite 进行项目构建和优化

* **性能优化：**
    * 使用懒加载技术，仅在需要时加载某些组件
    * 优化图片和图标资源，确保快速加载
    * 实现离线功能，允许在无网络连接时使用基本功能

### 3. 测试用例设计：

* **功能测试：**
    1. 验证插件图标是否正确显示并可点击
    2. 测试输入框的展开和收起功能
    3. 确保"分析"按钮在有输入时才可点击
    4. 验证意图识别界面的天使和恶魔卡片是否正确显示并可选择
    5. 测试回复生成界面的复制和刷新功能
    6. 确保可以从回复生成界面返回到意图识别界面

* **兼容性测试：**
    1. 在不同浏览器（Chrome、Firefox、Safari等）中测试插件
    2. 在不同操作系统（Windows、macOS、Linux）上测试

* **响应式设计测试：**
    1. 在不同尺寸的浏览器窗口中测试插件界面
    2. 模拟不同设备（桌面、平板、手机）测试界面适配

* **性能测试：**
    1. 测试插件启动时间
    2. 验证页面切换的流畅度
    3. 检查内存使用情况，确保不存在内存泄漏

* **用户体验测试：**
    1. 进行用户调研，收集对界面设计的反馈
    2. 测试色盲模式下的可用性
    3. 验证键盘导航的可用性，确保无障碍访问

### 4. 实现注意事项：

1. 确保设计风格统一，维持整体美观性
2. 注重细节，如按钮状态变化、输入框焦点效果等
3. 实现错误处理和用户提示，增强用户体验
4. 考虑国际化，为将来的多语言支持做准备
5. 遵循 Web 可访问性标准，确保所有用户都能方便使用
6. 优化插件在不同浏览器中的性能和兼容性
7. 考虑添加简短的使用教程或提示，帮助新用户快速上手
8. 实现数据持久化，保存用户的偏好设置（如上次选择的版本）